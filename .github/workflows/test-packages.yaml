name: Test Package Building

on:
  workflow_dispatch:

jobs:
  test-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y rpm-build rpmdevtools sbcl libfixposix-devel gcc make grep

      - name: Setup rpmbuild directory
        run: rpmdev-setuptree

      - name: Create source tarball
        run: |
          VERSION=$(grep '^\s*:version' ocicl.asd | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Building version: $VERSION"
          # Create tarball with proper directory prefix for rpmbuild
          mkdir -p /tmp/ocicl-${VERSION}
          cp -r . /tmp/ocicl-${VERSION}/
          rm -rf /tmp/ocicl-${VERSION}/.git
          tar czf ~/rpmbuild/SOURCES/ocicl-${VERSION}.tar.gz -C /tmp ocicl-${VERSION}

      - name: Build RPM and SRPM
        run: |
          VERSION=$(grep '^\s*:version' ocicl.asd | head -1 | sed 's/.*"\(.*\)".*/\1/')
          sed -i "s/^Version:.*/Version:        ${VERSION}/" releng/ocicl.spec
          cp releng/ocicl.spec ~/rpmbuild/SPECS/
          cd ~/rpmbuild/SPECS
          rpmbuild -ba ocicl.spec

      - name: List built packages
        run: |
          echo "Binary RPMs:"
          ls -lh ~/rpmbuild/RPMS/x86_64/
          echo "Source RPMs:"
          ls -lh ~/rpmbuild/SRPMS/

      - name: Test installation
        run: |
          dnf install -y ~/rpmbuild/RPMS/x86_64/*.rpm
          ocicl version

  test-deb:
    runs-on: ubuntu-latest
    container:
      image: debian:stable
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y debhelper devscripts sbcl libfixposix-dev gcc make

      - name: Build DEB packages (binary and source)
        run: |
          ln -s releng/debian debian
          dpkg-buildpackage -uc -us

      - name: List built packages
        run: |
          echo "Binary packages:"
          ls -lh ../*.deb 2>/dev/null || true
          echo "Source packages:"
          ls -lh ../*.dsc ../*.tar.* 2>/dev/null || true

      - name: Test installation
        run: |
          apt-get install -y ../*.deb
          ocicl version
